import{_ as a,o,c as n,ai as i}from"./chunks/framework.Bm4BMKaq.js";const g=JSON.parse('{"title":"How Execution Works","description":"","frontmatter":{},"headers":[],"relativePath":"explanation/how-it-works/core/execution.md","filePath":"explanation/how-it-works/core/execution.md"}'),s={name:"explanation/how-it-works/core/execution.md"};function t(r,e,l,d,c,h){return o(),n("div",null,[...e[0]||(e[0]=[i(`<h1 id="how-execution-works" tabindex="-1">How Execution Works <a class="header-anchor" href="#how-execution-works" aria-label="Permalink to “How Execution Works”">​</a></h1><p>How command execution works under the hood, step by step.</p><h2 id="pipeline" tabindex="-1">Pipeline <a class="header-anchor" href="#pipeline" aria-label="Permalink to “Pipeline”">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>argv</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├─ 1. Route ──────────── Match command from the nested command tree</span></span>
<span class="line"><span>  ├─ 2. Parse ──────────── Extract positional args and options (resolve aliases)</span></span>
<span class="line"><span>  ├─ 3. Middleware ─────── Run middleware chain, build shared context</span></span>
<span class="line"><span>  ├─ 4. Validate ───────── Check for unknown options, then Zod-validate positional &amp; options</span></span>
<span class="line"><span>  ├─ 5. Global options ─── Execute global option handlers (may short-circuit)</span></span>
<span class="line"><span>  ├─ 6. Plugin hooks ───── onPreCommandExecution (global + command plugins)</span></span>
<span class="line"><span>  ├─ 7. Handler ────────── Execute command handler with validated params</span></span>
<span class="line"><span>  └─ 8. Plugin hooks ───── onAfterCommandExecution (always runs, even on error)</span></span></code></pre></div><h2 id="entry-point" tabindex="-1">Entry Point <a class="header-anchor" href="#entry-point" aria-label="Permalink to “Entry Point”">​</a></h2><p><code>executeCli()</code> receives <code>{ cli, args }</code> (args default to <code>process.argv.slice(2)</code>).</p><ol><li>Shows deprecation warning if CLI is deprecated</li><li>Resolves the command from the tree</li><li>Shows deprecation warning if the matched command is deprecated</li><li>Runs the command pipeline</li><li>On error: formats and logs via <code>handleError()</code>, then <code>process.exit(1)</code></li><li><strong>Finally</strong>: runs <code>onDestroy</code> plugin hooks (always, even on error)</li></ol><h2 id="routing" tabindex="-1">Routing <a class="header-anchor" href="#routing" aria-label="Permalink to “Routing”">​</a></h2><p>Walks the nested command tree by consuming argv segments:</p><ul><li>Each non-flag arg (<code>!startsWith(&#39;-&#39;)</code>) is matched against command <code>paths</code></li><li>On match: descend into that subcommand, consume the segment</li><li>On no match or flag: stop — current command is the target</li><li>Remaining argv is forwarded to the command as its own args</li></ul><h2 id="command-pipeline" tabindex="-1">Command Pipeline <a class="header-anchor" href="#command-pipeline" aria-label="Permalink to “Command Pipeline”">​</a></h2><p>This is the core of execution. Runs in this exact order:</p><h3 id="_1-alias-map" tabindex="-1">1. Alias Map <a class="header-anchor" href="#_1-alias-map" aria-label="Permalink to “1. Alias Map”">​</a></h3><p>Merges command option aliases (from Zod <code>.meta({ aliases })</code>) with global option aliases into a single lookup map.</p><h3 id="_2-argument-parsing" tabindex="-1">2. Argument Parsing <a class="header-anchor" href="#_2-argument-parsing" aria-label="Permalink to “2. Argument Parsing”">​</a></h3><p>Splits raw argv into <code>{ positional: string[], options: Record&lt;string, any&gt; }</code> using mri with the alias map.</p><h3 id="_3-middleware" tabindex="-1">3. Middleware <a class="header-anchor" href="#_3-middleware" aria-label="Permalink to “3. Middleware”">​</a></h3><p>Runs the middleware array sequentially. All middleware share a single mutable <code>context</code> (<code>Record&lt;string, any&gt;</code>). Each middleware calls <code>next()</code> to advance the chain. The resulting context is forwarded to the handler.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>middleware[0]({ context, next }) → middleware[1]({ context, next }) → ... → done</span></span>
<span class="line"><span>                                              ↑ same object</span></span></code></pre></div><h3 id="_4-extraneous-options" tabindex="-1">4. Extraneous Options <a class="header-anchor" href="#_4-extraneous-options" aria-label="Permalink to “4. Extraneous Options”">​</a></h3><p>Checks parsed options against the schema + global option names. Behavior depends on <code>throwOnExtrageousOptions</code>:</p><ul><li><code>&#39;throw&#39;</code> (default): throws <code>InvalidOptionsError</code></li><li><code>&#39;filter-out&#39;</code>: silently drops unknown options</li><li><code>&#39;pass-through&#39;</code>: keeps them for the handler</li></ul><h3 id="_5-global-option-handlers" tabindex="-1">5. Global Option Handlers <a class="header-anchor" href="#_5-global-option-handlers" aria-label="Permalink to “5. Global Option Handlers”">​</a></h3><p>Iterates global options. If a global option is present in parsed args:</p><ul><li>Validates its value against its Zod schema</li><li>If it has a handler (e.g. <code>--help</code>, <code>--version</code>): executes it and <strong>returns early</strong> (short-circuits the rest of the pipeline)</li></ul><h3 id="_6-positional-validation" tabindex="-1">6. Positional Validation <a class="header-anchor" href="#_6-positional-validation" aria-label="Permalink to “6. Positional Validation”">​</a></h3><p>Extracts the positional value, shows deprecation warning if applicable, then runs <code>schema.parse()</code>. Throws <code>InvalidPositionalError</code> on failure.</p><h3 id="_7-options-validation" tabindex="-1">7. Options Validation <a class="header-anchor" href="#_7-options-validation" aria-label="Permalink to “7. Options Validation”">​</a></h3><p>Separates valid vs. extra options, shows deprecation warnings, then runs <code>schema.parse()</code> on valid options. For <code>&#39;pass-through&#39;</code> mode, extra options are merged back into the result.</p><h3 id="_8-pre-execution-plugin-hooks" tabindex="-1">8. Pre-Execution Plugin Hooks <a class="header-anchor" href="#_8-pre-execution-plugin-hooks" aria-label="Permalink to “8. Pre-Execution Plugin Hooks”">​</a></h3><p>Collects global plugins first, then command-level plugins (created on the fly from definitions). Runs <code>onPreCommandExecution</code> hooks in order. If a hook throws, the handler does not execute.</p><h3 id="_9-handler" tabindex="-1">9. Handler <a class="header-anchor" href="#_9-handler" aria-label="Permalink to “9. Handler”">​</a></h3><p>Calls the command handler with:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>{ positional, options, context, command, cli }</span></span></code></pre></div><h3 id="_10-post-execution-plugin-hooks" tabindex="-1">10. Post-Execution Plugin Hooks <a class="header-anchor" href="#_10-post-execution-plugin-hooks" aria-label="Permalink to “10. Post-Execution Plugin Hooks”">​</a></h3><p>Runs <code>onAfterCommandExecution</code> in a <code>finally</code> block — always executes, even if the handler threw. Hook errors are logged but don&#39;t override the original error.</p><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to “Error Handling”">​</a></h2><p>Errors are handled by <code>handleError()</code>, which distinguishes between:</p><ul><li><strong>Validation errors</strong> (<code>InvalidPositionalError</code>, <code>InvalidOptionsError</code>): structured Zod issues — each is logged with the field name and description extracted from the manifest</li><li><strong>Standard errors</strong>: logs the message</li><li><strong>Unknown errors</strong>: logs a generic message</li></ul><p>After logging, <code>executeCli()</code> calls <code>process.exit(1)</code>.</p>`,40)])])}const m=a(s,[["render",t]]);export{g as __pageData,m as default};
